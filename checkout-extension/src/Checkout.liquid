{%- if flavor contains "preact" -%}
import '@shopify/ui-extensions/preact';
import {render} from "preact";

// 1. Export the extension
export default async () => {
  render(<Extension />, document.body)
};

function Extension() {
  // 2. Check instructions for feature availability
  if (!shopify.instructions.value.metafields.canSetCartMetafields) {
    return (
      <s-banner heading="{{ name }}" tone="warning">
        {shopify.i18n.translate("metafieldChangesAreNotSupported")}
      </s-banner>
    );
  }

  const freeGiftRequested = shopify.appMetafields.value.find(
    (appMetafield) =>
      appMetafield.target.type === "cart" &&
      appMetafield.metafield.namespace === "$app" &&
      appMetafield.metafield.key === "requestedFreeGift",
  );

  // 3. Render a UI
  return (
    <s-banner heading="{{ name }}">
      <s-stack gap="base">
        <s-text>
          {shopify.i18n.translate("welcome", {
            target: <s-text type="emphasis">{shopify.extension.target}</s-text>,
          })}
        </s-text>
        <s-checkbox
          checked={freeGiftRequested?.metafield?.value === "true"}
          onChange={onCheckboxChange}
          label={shopify.i18n.translate("iWouldLikeAFreeGiftWithMyOrder")}
        />
      </s-stack>
    </s-banner>
  );

  async function onCheckboxChange(event) {
    const isChecked = event.target.checked;
    // 4. Call the API to modify checkout
    const result = await shopify.applyMetafieldChange({
      type: "updateCartMetafield",
      metafield: {
        namespace: "$app",
        key: "requestedFreeGift",
        value: isChecked ? "true" : "false",
        type: "boolean",
      },
    });
    console.log("applyMetafieldChange result", result);
  }
}
{%- elsif flavor contains "react" -%}
import {
  reactExtension,
  Banner,
  BlockStack,
  Checkbox,
  Text,
  useApi,
  useAppMetafields,
  useApplyMetafieldsChange,
  useInstructions,
  useTranslate,
} from "@shopify/ui-extensions-react/checkout";

// 1. Choose an extension target
export default reactExtension("purchase.checkout.block.render", () => (
  <Extension />
));

function Extension() {
  const translate = useTranslate();
  const { extension } = useApi();
  const instructions = useInstructions();
  const applyMetafieldChange = useApplyMetafieldsChange();

  // 2. Check instructions for feature availability, see https://shopify.dev/docs/api/checkout-ui-extensions/apis/cart-instructions for details
  if (!instructions.metafields.canSetCartMetafields) {
    return (
      <Banner title="{{ name }}" status="warning">
        {translate("metafieldChangesAreNotSupported")}
      </Banner>
    );
  }

  const freeGiftRequested = useAppMetafields().find(
    (appMetafield) =>
      appMetafield.target.type === "cart" &&
      appMetafield.metafield.namespace === "$app" &&
      appMetafield.metafield.key === "requestedFreeGift",
  );

  // 3. Render a UI
  return (
    <BlockStack border={"dotted"} padding={"tight"}>
      <Banner title="{{ name }}">
        {translate("welcome", {
          target: <Text emphasis="italic">{extension.target}</Text>,
        })}
      </Banner>
      <Checkbox
        checked={freeGiftRequested?.metafield?.value === "true"}
        onChange={onCheckboxChange}
      >
        {translate("iWouldLikeAFreeGiftWithMyOrder")}
      </Checkbox>
    </BlockStack>
  );

  async function onCheckboxChange(isChecked) {
    // 4. Call the API to modify checkout
    const result = await applyMetafieldChange({
      type: "updateCartMetafield",
      metafield: {
        namespace: "$app",
        key: "requestedFreeGift",
        value: isChecked ? "true" : "false",
        type: "boolean",
      },
    });
    console.log("applyMetafieldChange result", result);
  }
}

{%- else -%}
import {
  extension,
  Banner,
  BlockStack,
  Checkbox,
  Text,
} from "@shopify/ui-extensions/checkout";

// 1. Choose an extension target
export default extension("purchase.checkout.block.render", (root, api) => {
  // 2. Check instructions for feature availability, see https://shopify.dev/docs/api/checkout-ui-extensions/apis/cart-instructions for details
  api.instructions.subscribe((instructions) => {
    if (!instructions.metafields.canSetCartMetafields) {
      root.replaceChildren(
        root.createComponent(
          Banner,
          { title: "{{ name }}", status: "warning" },
          api.i18n.translate("metafieldChangesAreNotSupported")
        )
      );
    } else {
  const freeGiftRequested = api.appMetafields.current.find(
    (appMetafield) =>
      appMetafield.target.type === "cart" &&
      appMetafield.metafield.namespace === "$app" &&
      appMetafield.metafield.key === "requestedFreeGift",
  );

      // 3. Render a UI
      root.replaceChildren(
        root.createComponent(
          BlockStack,
          { border: "dotted", padding: "tight" },
          [
            root.createComponent(
              Banner,
              { title: "{{ name }}" },
              api.i18n.translate("welcome", {
                target: root.createComponent(
                  Text,
                  { emphasis: "italic" },
                  api.extension.target
                ),
              })
            ),
            root.createComponent(
              Checkbox,
              {
                checked: freeGiftRequested?.metafield?.value === "true",
                onChange: onCheckboxChange,
              },
              api.i18n.translate("iWouldLikeAFreeGiftWithMyOrder")
            ),
          ]
        )
      );
    }

    async function onCheckboxChange(isChecked) {
      // 4. Call the API to modify checkout
      const result = await api.applyMetafieldChange({
        type: "updateCartMetafield",
        metafield: {
          namespace: "$app",
          key: "requestedFreeGift",
          value: isChecked ? "true" : "false",
          type: "boolean",
        },
      });
      console.log("applyMetafieldChange result", result);
    }
  });
});
{%- endif -%}
